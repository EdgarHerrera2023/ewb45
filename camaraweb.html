<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C치mara con detecci칩n de movimiento</title>

  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    video, img {
      width: 90%;
      max-width: 640px;
      margin-top: 10px;
      border-radius: 10px;
    }

    button {
      margin: 10px;
      padding: 10px 18px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: #00e5ff;
      color: #000;
      cursor: pointer;
    }

    #alerta {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>C치mara de la computadora</h2>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>

  <button onclick="iniciarCamara()">Iniciar c치mara</button>

  <div id="alerta"></div>

  <h3>칔ltima foto capturada</h3>
  <img id="foto">

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const alerta = document.getElementById("alerta");
    const foto = document.getElementById("foto");

    let frameAnterior = null;
    let ultimaFoto = 0;
    const TIEMPO_ENTRE_FOTOS = 5000; // 5 segundos
    const SENSIBILIDAD = 5_000_000;

    function iniciarCamara() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          detectarMovimiento();
        })
        .catch(err => {
          alert("No se pudo acceder a la c치mara");
          console.error(err);
        });
    }

    function sacarFoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      foto.src = canvas.toDataURL("image/png");
    }

    function detectarMovimiento() {
      setInterval(() => {
        if (video.videoWidth === 0) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const frameActual = ctx.getImageData(0, 0, canvas.width, canvas.height);

        if (frameAnterior) {
          let diferencia = 0;

          for (let i = 0; i < frameActual.data.length; i += 4) {
            diferencia += Math.abs(frameActual.data[i] - frameAnterior.data[i]);
          }

          if (diferencia > SENSIBILIDAD) {
            const ahora = Date.now();

            alerta.textContent = "游뚿 Movimiento detectado";

            if (ahora - ultimaFoto > TIEMPO_ENTRE_FOTOS) {
              sacarFoto();
              ultimaFoto = ahora;
            }
          } else {
            alerta.textContent = "";
          }
        }

        frameAnterior = frameActual;
      }, 500);
    }
  </script>

</body>
</html>
